<!DOCTYPE html>

{% extends "base.html" %}


{% block "content" %}

<html>

<head>
  <title>Buy cool new product</title>
  <link rel="stylesheet" href="../static/stylesheets/styles.css">
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body class="container">
  {% if product_available %}
  <section>
    <div class="product">
      <!-- <img src="../media/images/11.jpg" alt="SAMPLE IMAGE" width="500" height="500" /> -->
      <div class="description">
        <h3>{{ product.name }}</h3>
        <h5>${{ product.get_display_price }}</h5>
      </div>
    </div>
    <button class="btn btn-success" type="button" id="checkout-button">Checkout</button>
  </section>
  {% else %}
  <section>
    <div class="alert alert-warning" role="alert">
      <h4 class="alert-heading">Product Unavailable</h4>
      <p>{{ error_message }}</p>
    </div>
  </section>
  {% endif %}
  {% csrf_token %}
</body>

{% if product_available %}
<body>
  <section>
    <div class="product">
      <div class="description">
        <h3>{{ product.name }} Subscription</h3>
        <h5>${{ product.get_display_price }} / month</h5>
      </div>
    </div>
    <button class="btn btn-success" type="button" id="checkout-button">Checkout</button>
  </section>
  {% csrf_token %}
</body>
<script type="text/javascript">
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  // Create an instance of the Stripe object with your publishable API key
  var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
  var checkoutButton = document.getElementById("checkout-button");
  checkoutButton.addEventListener("click", function () {
    fetch("{% url 'create-checkout-session' product.id %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': csrftoken
      }
    })
      .then(function (response) {
        return response.json();
      })
      .then(function (session) {
        return stripe.redirectToCheckout({ sessionId: session.id });
      })
      .then(function (result) {
        // If redirectToCheckout fails due to a browser or network
        // error, you should display the localized error message to your
        // customer using error.message.
        if (result.error) {
          alert(result.error.message);
        }
      })
      .catch(function (error) {
        console.error("Error:", error);
      });
  });
</script>
{% endif %}

</html>

{% endblock %}